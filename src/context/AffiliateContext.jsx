import React, { createContext, useContext, useState, useEffect } from 'react'
import { supabase } from '../config/supabase'
import { executeSupabaseQuery } from '../utils/networkUtils'

const AffiliateContext = createContext()

export const useAffiliate = () => {
  const context = useContext(AffiliateContext)
  if (!context) {
    throw new Error('useAffiliate must be used within an AffiliateProvider')
  }
  return context
}

// Configuration par d√©faut des influenceurs
const defaultAffiliates = {
  APPLE: { 
    STFOUR: "https://apple.com/gs", 
    GLBNS: "https://apple.com/gb" 
  },
  MIC: { 
    STFOUR: "https://mic.com/gs", 
    GLBNS: "https://mic.com/gb" 
  }
}

// Pages de paiement par d√©faut
const defaultPaymentPages = { 
  STFOUR: "https://triumtrade.thrivecart.com/starter-fournisseurs-og/", 
  GLBNS: "https://triumtrade.thrivecart.com/global-business-og/" 
}

export const AffiliateProvider = ({ children }) => {
  const [affiliateCode, setAffiliateCode] = useState('')
  const [affiliates, setAffiliates] = useState(defaultAffiliates)
  const [paymentPages, setPaymentPages] = useState(defaultPaymentPages)

  // Charger la configuration depuis un fichier externe (simulation)
  useEffect(() => {
    loadAffiliateConfig()
  }, [])

  // Charger la configuration depuis Supabase
  const loadAffiliateConfig = async () => {
    try {
      // Utiliser la fonction avec retry pour charger la configuration
      const result = await executeSupabaseQuery(async () => {
        return await supabase
          .from('affiliate_config')
          .select('config_key, config_value')
          .in('config_key', ['affiliates', 'defaultPages'])
      }, {
        fallbackData: [],
        onRetry: (attempt, maxAttempts, errorType) => {
          console.log(`üîÑ Retry ${attempt}/${maxAttempts} pour loadAffiliateConfig (${errorType})`)
        },
        onError: (error) => {
          console.error('‚ùå √âchec d√©finitif pour loadAffiliateConfig:', error)
        }
      })

      if (result.success && result.data && result.data.length > 0) {
        // Transformer les donn√©es en objet utilisable
        result.data.forEach(item => {
          if (item.config_key === 'affiliates') {
            setAffiliates(item.config_value)
            console.log('Affili√©s charg√©s depuis Supabase:', item.config_value)
          } else if (item.config_key === 'defaultPages') {
            setPaymentPages(item.config_value)
            console.log('Pages de paiement charg√©es depuis Supabase:', item.config_value)
          }
        })
      } else {
        console.log('Aucune configuration trouv√©e dans Supabase, utilisation des valeurs par d√©faut')
      }
    } catch (error) {
      console.error('Erreur lors du chargement de la configuration:', error)
      console.log('Utilisation de la configuration par d√©faut')
    }
  }

  // Fonction pour sauvegarder de mani√®re robuste
  const saveAffiliateCode = (code) => {
    try {
      // Essayer localStorage d'abord
      localStorage.setItem('evocom-affiliate', code)
      
      // Backup avec sessionStorage
      sessionStorage.setItem('evocom-affiliate', code)
      
      // Backup avec cookie (plus fiable sur mobile)
      document.cookie = `evocom-affiliate=${code}; path=/; max-age=${7 * 24 * 60 * 60}` // 7 jours
      
      console.log(`Code partenaire sauvegard√©: ${code}`)
    } catch (error) {
      console.warn('Erreur lors de la sauvegarde du code partenaire:', error)
    }
  }

  // Fonction pour r√©cup√©rer le code de mani√®re robuste
  const getSavedAffiliateCode = () => {
    try {
      // Debug localStorage sur mobile
      console.log('üîç Debug localStorage mobile:', {
        localStorage_available: typeof localStorage !== 'undefined',
        sessionStorage_available: typeof sessionStorage !== 'undefined',
        cookies_available: typeof document !== 'undefined' && typeof document.cookie !== 'undefined',
        userAgent: navigator.userAgent,
        isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
      })
      
      // Essayer localStorage d'abord
      let savedCode = localStorage.getItem('evocom-affiliate')
      console.log('üì± localStorage result:', savedCode)
      
      // Si pas trouv√©, essayer sessionStorage
      if (!savedCode) {
        savedCode = sessionStorage.getItem('evocom-affiliate')
        console.log('üì± sessionStorage result:', savedCode)
      }
      
      // Si toujours pas trouv√©, essayer les cookies
      if (!savedCode) {
        const cookies = document.cookie.split(';')
        const affiliateCookie = cookies.find(cookie => 
          cookie.trim().startsWith('evocom-affiliate=')
        )
        if (affiliateCookie) {
          savedCode = affiliateCookie.split('=')[1]
          console.log('üì± cookie result:', savedCode)
        }
      }
      
      return savedCode
    } catch (error) {
      console.warn('Erreur lors de la r√©cup√©ration du code partenaire:', error)
      return null
    }
  }

  // D√©tecter le param√®tre AF dans l'URL
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search)
    const afParam = urlParams.get('AF')
    
    console.log('üîç D√©tection AF:', {
      afParam,
      currentAffiliateCode: affiliateCode,
      affiliates: Object.keys(affiliates)
    })
    
    if (afParam) {
      const upperAfParam = afParam.toUpperCase()
      
      // V√©rifier si le code existe dans la configuration
      if (affiliates[upperAfParam]) {
        setAffiliateCode(upperAfParam)
        // Sauvegarder de mani√®re robuste
        saveAffiliateCode(upperAfParam)
        console.log(`‚úÖ Code partenaire valide activ√©: ${upperAfParam}`)
      } else {
        console.warn(`‚ùå Code partenaire invalide: ${upperAfParam}`)
        // Supprimer les codes invalides
        try {
          localStorage.removeItem('evocom-affiliate')
          sessionStorage.removeItem('evocom-affiliate')
          document.cookie = 'evocom-affiliate=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
        } catch (error) {
          console.warn('Erreur lors de la suppression du code invalide:', error)
        }
      }
    } else {
      // V√©rifier s'il y a un code sauvegard√©
      const savedAffiliate = getSavedAffiliateCode()
      console.log('üîç Code sauvegard√© trouv√©:', savedAffiliate)
      
      if (savedAffiliate && affiliates[savedAffiliate]) {
        setAffiliateCode(savedAffiliate)
        console.log(`‚úÖ Code partenaire restaur√©: ${savedAffiliate}`)
      } else if (savedAffiliate) {
        console.log(`‚ùå Code sauvegard√© invalide: ${savedAffiliate}`)
        // Le code sauvegard√© n'existe plus dans la config, le supprimer
        try {
          localStorage.removeItem('evocom-affiliate')
          sessionStorage.removeItem('evocom-affiliate')
          document.cookie = 'evocom-affiliate=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
        } catch (error) {
          console.warn('Erreur lors de la suppression du code invalide:', error)
        }
      } else {
        console.log('‚ÑπÔ∏è Aucun code partenaire trouv√©')
      }
    }
  }, [affiliates])

  // Obtenir le lien de paiement pour un produit donn√©
  const getPaymentLink = (productId) => {
    console.log('üîç getPaymentLink appel√©:', {
      productId,
      affiliateCode,
      hasAffiliate: !!affiliateCode,
      currentAffiliate: affiliates[affiliateCode],
      paymentPages: paymentPages[productId]
    })
    
    const currentAffiliate = affiliates[affiliateCode]
    
    if (currentAffiliate && currentAffiliate[productId]) {
      console.log('‚úÖ Lien affili√© trouv√©:', currentAffiliate[productId])
      return currentAffiliate[productId]
    }
    
    // Retourner la page par d√©faut
    const defaultLink = paymentPages[productId] || '#'
    console.log('‚ÑπÔ∏è Utilisation du lien par d√©faut:', defaultLink)
    return defaultLink
  }

  // Obtenir le code d'affiliation actuel
  const getCurrentAffiliateCode = () => {
    console.log('üîç getCurrentAffiliateCode appel√©:', {
      affiliateCode,
      hasAffiliate: !!affiliateCode,
      affiliates: Object.keys(affiliates)
    })
    return affiliateCode
  }

  // V√©rifier si un code d'affiliation est actif
  const hasAffiliateCode = () => {
    return affiliateCode && affiliateCode.length > 0
  }

  // Mettre √† jour la configuration (pour l'interface d'admin)
  const updateAffiliateConfig = async (newAffiliates, newPaymentPages) => {
    try {
      console.log('üîÑ D√©but de la sauvegarde...')
      
      // Sauvegarder les affili√©s
      // V√©rifier si l'enregistrement existe (sans .single() qui peut causer des erreurs)
      const { data: existingAffiliates, error: checkAffiliatesError } = await supabase
        .from('affiliate_config')
        .select('id')
        .eq('config_key', 'affiliates')
        .maybeSingle()

      if (checkAffiliatesError) {
        console.error('Erreur v√©rification affili√©s:', checkAffiliatesError)
        throw checkAffiliatesError
      }

      if (existingAffiliates) {
        // UPDATE
        console.log('üìù Mise √† jour des affili√©s existants...')
        const { error: affiliatesError } = await supabase
          .from('affiliate_config')
          .update({
            config_value: newAffiliates,
            updated_at: new Date().toISOString()
          })
          .eq('config_key', 'affiliates')

        if (affiliatesError) {
          console.error('Erreur UPDATE affili√©s:', affiliatesError)
          throw affiliatesError
        }
        console.log('‚úÖ Affili√©s mis √† jour')
      } else {
        // INSERT
        console.log('‚ûï Insertion de nouveaux affili√©s...')
        const { error: affiliatesError } = await supabase
          .from('affiliate_config')
          .insert({
            config_key: 'affiliates',
            config_value: newAffiliates,
            updated_at: new Date().toISOString()
          })

        if (affiliatesError) {
          console.error('Erreur INSERT affili√©s:', affiliatesError)
          throw affiliatesError
        }
        console.log('‚úÖ Affili√©s ins√©r√©s')
      }

      // Sauvegarder les pages de paiement
      const { data: existingPages, error: checkPagesError } = await supabase
        .from('affiliate_config')
        .select('id')
        .eq('config_key', 'defaultPages')
        .maybeSingle()

      if (checkPagesError) {
        console.error('Erreur v√©rification pages:', checkPagesError)
        throw checkPagesError
      }

      if (existingPages) {
        // UPDATE
        console.log('üìù Mise √† jour des pages existantes...')
        const { error: pagesError } = await supabase
          .from('affiliate_config')
          .update({
            config_value: newPaymentPages,
            updated_at: new Date().toISOString()
          })
          .eq('config_key', 'defaultPages')

        if (pagesError) {
          console.error('Erreur UPDATE pages:', pagesError)
          throw pagesError
        }
        console.log('‚úÖ Pages mises √† jour')
      } else {
        // INSERT
        console.log('‚ûï Insertion de nouvelles pages...')
        const { error: pagesError } = await supabase
          .from('affiliate_config')
          .insert({
            config_key: 'defaultPages',
            config_value: newPaymentPages,
            updated_at: new Date().toISOString()
          })

        if (pagesError) {
          console.error('Erreur INSERT pages:', pagesError)
          throw pagesError
        }
        console.log('‚úÖ Pages ins√©r√©es')
      }

      // Mettre √† jour le state local apr√®s sauvegarde r√©ussie
      setAffiliates(newAffiliates)
      setPaymentPages(newPaymentPages)
      
      console.log('‚úÖ Configuration sauvegard√©e avec succ√®s dans Supabase')
      return { success: true }
    } catch (error) {
      console.error('‚ùå Erreur lors de la mise √† jour:', error)
      console.error('D√©tails:', error.message, error.details, error.hint)
      return { success: false, error }
    }
  }

  // Fonction de test pour v√©rifier le localStorage
  const testLocalStorage = () => {
    const testResults = {
      localStorage: {
        available: typeof localStorage !== 'undefined',
        test: null,
        error: null
      },
      sessionStorage: {
        available: typeof sessionStorage !== 'undefined',
        test: null,
        error: null
      },
      cookies: {
        available: typeof document !== 'undefined' && typeof document.cookie !== 'undefined',
        test: null,
        error: null
      }
    }

    // Test localStorage
    try {
      if (typeof localStorage !== 'undefined') {
        localStorage.setItem('test-key', 'test-value')
        testResults.localStorage.test = localStorage.getItem('test-key') === 'test-value'
        localStorage.removeItem('test-key')
      }
    } catch (error) {
      testResults.localStorage.error = error.message
    }

    // Test sessionStorage
    try {
      if (typeof sessionStorage !== 'undefined') {
        sessionStorage.setItem('test-key', 'test-value')
        testResults.sessionStorage.test = sessionStorage.getItem('test-key') === 'test-value'
        sessionStorage.removeItem('test-key')
      }
    } catch (error) {
      testResults.sessionStorage.error = error.message
    }

    // Test cookies
    try {
      if (typeof document !== 'undefined') {
        document.cookie = 'test-key=test-value; path=/'
        testResults.cookies.test = document.cookie.includes('test-key=test-value')
        document.cookie = 'test-key=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
      }
    } catch (error) {
      testResults.cookies.error = error.message
    }

    return testResults
  }

  // Fonction pour tester les liens AF
  const testAffiliateLinks = () => {
    const testResults = {
      currentCode: affiliateCode,
      availableAffiliates: Object.keys(affiliates),
      paymentPages: Object.keys(paymentPages),
      testLinks: {}
    }

    // Tester les liens pour chaque affili√©
    Object.keys(affiliates).forEach(affiliateName => {
      testResults.testLinks[affiliateName] = {
        STFOUR: affiliates[affiliateName].STFOUR,
        GLBNS: affiliates[affiliateName].GLBNS
      }
    })

    return testResults
  }

  const value = {
    affiliateCode,
    getPaymentLink,
    getCurrentAffiliateCode,
    hasAffiliateCode,
    updateAffiliateConfig,
    affiliates,
    paymentPages,
    testLocalStorage,
    testAffiliateLinks
  }

  return (
    <AffiliateContext.Provider value={value}>
      {children}
    </AffiliateContext.Provider>
  )
}
